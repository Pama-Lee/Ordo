# Ordo 商业化产品 Roadmap

> 版本: 1.0  
> 更新时间: 2026-01-09  
> 目标客户: 金融/支付、电商/营销、大型互联网企业  
> 部署模式: 私有化部署优先，支持 SaaS

---

## 设计原则

**核心理念**: 规则引擎必须是一个**自治系统**，能够在任何外部依赖失效时独立运行。

```
关键场景保障:
1. 规则管理系统挂了 → 引擎继续用本地规则执行
2. 引擎进程重启/崩溃 → 秒级恢复，规则不丢失  
3. 网络分区 → 引擎独立运行，恢复后自动同步
4. 规则推送失败 → 降级使用旧版本，不影响业务
```

---

## 当前状态

### 已完成

- [x] Core Engine: 1.63µs 执行延迟, 500K+ QPS
- [x] HTTP REST API
- [x] gRPC 基础支持
- [x] 执行追踪 (Tracing)
- [x] 内置函数库 (20+)
- [x] WASM 浏览器执行
- [x] 可视化规则编辑器 (Vue)
- [x] Flow 图执行追踪可视化
- [x] 多语言支持 (i18n)

### 待完善

- [ ] 规则仅存内存，重启丢失
- [ ] 无本地持久化
- [ ] 无离线运行能力
- [ ] 无崩溃恢复机制

---

## Phase 1: 自治与容灾 (Autonomy) - 6-8 周

**目标**: 引擎具备完全自治能力，零外部依赖运行

### 1.1 本地规则持久化

**架构设计**:

```
┌─────────────────────────────────────────────────┐
│           Rule Management System                 │
│          (外部运营系统，可断开)                   │
└─────────────────┬───────────────────────────────┘
                  │ Push (可失败)
                  ▼
┌─────────────────────────────────────────────────┐
│              Ordo Rule Engine                    │
│  ┌───────────┐  ┌───────────┐  ┌─────────────┐ │
│  │  Memory   │◄─│  WAL Log  │◄─│ Local Store │ │
│  │  Cache    │  │ (append)  │  │  (SQLite)   │ │
│  └─────┬─────┘  └───────────┘  └─────────────┘ │
│        │                                        │
│   [Execute]  ← 执行请求永远走内存缓存            │
└────────┼────────────────────────────────────────┘
```

**实现要点**:

| 组件 | 说明 |
|------|------|
| 嵌入式 SQLite | 规则本地持久化，零外部依赖 |
| WAL 日志 | 规则变更先写日志，保证崩溃恢复 |
| 内存缓存 | 执行时零 I/O，纯内存操作 |
| 定期快照 | 压缩 WAL，加速启动恢复 |

**文件结构**:

```
/var/lib/ordo/
├── rules.db          # SQLite 主存储
├── wal/              # Write-Ahead Log
│   ├── 000001.log
│   └── 000002.log
├── snapshots/        # 定期快照
│   └── snap_20240108_001.db
└── config.yaml       # 引擎配置
```

### 1.2 崩溃恢复机制

**恢复流程**:

```
启动 → 检测本地存储 → 加载快照 → 重放WAL → 校验 → 服务就绪
                                              ↓
                                    后台: 与上游对账同步
```

**恢复时间目标**:

| 场景 | 目标时间 |
|------|----------|
| 冷启动 (10K规则) | < 3s |
| 热恢复 (有快照) | < 500ms |
| 增量恢复 (WAL) | < 100ms |

**目标**: 进程重启对业务无感知

### 1.3 离线运行模式

**状态机**:

```
        ┌──────────────────────────────────────┐
        │                                      │
        ▼                                      │
   ┌─────────┐  上游断开   ┌──────────┐        │
   │ ONLINE  │───────────►│ OFFLINE  │        │
   │ (同步)  │◄───────────│ (自治)   │        │
   └────┬────┘  上游恢复   └────┬─────┘        │
        │                       │              │
        │ 正常推送规则          │ 使用本地缓存  │
        │                       │              │
        │       ┌───────────────┘              │
        │       │ 离线期间变更入队             │
        │       ▼                              │
        │  ┌──────────┐                        │
        │  │ 同步队列 │─── 恢复后重放 ─────────┘
        │  └──────────┘
        ▼
   [业务执行不中断]
```

**降级策略**:

| 场景 | 处理方式 |
|------|----------|
| 新规则推送失败 | 继续使用旧版本 |
| 规则删除失败 | 标记待删除，下次同步 |
| 配置更新失败 | 使用本地配置 |

### 1.4 规则版本管理

- 每条规则保留 N 个历史版本 (可配置，默认10)
- 版本号: `{major}.{minor}.{patch}` 或自增序列
- 版本元数据: 创建时间、来源、校验和
- 支持按版本号/时间点回滚
- 自动回滚: 执行异常率超阈值时触发

### 1.5 健康检查与监控

**健康端点**:

```json
GET /health
{
  "status": "healthy|degraded|unhealthy",
  "mode": "online|offline",
  "storage": {
    "rules_count": 1234,
    "last_persist": "2024-01-08T10:00:00Z"
  },
  "upstream": {
    "connected": false,
    "last_sync": "2024-01-08T09:55:00Z",
    "pending_changes": 3
  }
}
```

**Prometheus Metrics**:

```prometheus
# 规则状态
ordo_rules_total{status="active"}
ordo_rules_version_info{name="xxx", version="1.0.0"}

# 引擎状态
ordo_engine_mode{mode="online|offline"}
ordo_engine_uptime_seconds

# 存储状态
ordo_storage_wal_size_bytes
ordo_storage_snapshot_age_seconds
ordo_storage_recovery_duration_seconds

# 同步状态
ordo_sync_lag_seconds
ordo_sync_queue_size
ordo_sync_failures_total

# 执行指标
ordo_execution_total{rule="xxx", result="success|error"}
ordo_execution_duration_seconds{quantile="0.5|0.9|0.99"}
ordo_execution_qps
```

---

## Phase 2: 企业级安全 (Security) - 4-6 周

**目标**: 满足金融级安全与合规要求

### 2.1 规则完整性校验

- 规则内容 SHA256 签名
- 推送时校验签名，防篡改
- 本地存储加密 (AES-256，可选)
- 签名密钥轮转支持

### 2.2 执行沙箱

| 限制项 | 默认值 | 说明 |
|--------|--------|------|
| 执行超时 | 100ms | 强制终止 |
| 内存限制 | 10MB | 单次执行 |
| 递归深度 | 100 | 已实现 max_depth |
| 循环次数 | 10000 | 防止死循环 |

- 禁止危险操作 (文件/网络访问)
- 资源隔离 (租户级别)

### 2.3 审计日志

**日志类型**:

| 类型 | 内容 | 存储 |
|------|------|------|
| 规则变更 | 谁/何时/改了什么 | 本地 + 上报 |
| 执行日志 | 输入/输出/耗时 | 采样存储 |
| 系统事件 | 启动/恢复/故障 | 本地 + 上报 |

**日志格式** (JSON):

```json
{
  "timestamp": "2024-01-08T10:00:00.123Z",
  "level": "INFO",
  "event": "rule_updated",
  "rule_name": "payment_check",
  "version": "1.0.0 -> 1.0.1",
  "operator": "admin@example.com",
  "source_ip": "10.0.0.1"
}
```

### 2.4 多租户隔离

- Namespace 隔离规则 (tenant_id)
- 租户级 QPS 限制
- 租户级配置 (超时/错误策略)
- 租户数据完全隔离

---

## Phase 3: 高性能优化 (Performance) - 4-6 周

**目标**: 进一步提升性能，支撑更大规模

### 3.1 表达式预编译

```
规则加载流程:
JSON/YAML → Parse → AST → Compile → ByteCode (缓存)
                                         ↓
执行流程:                            [直接执行]
```

- 规则加载时预编译表达式为 AST
- 缓存编译结果，避免重复解析
- 热点规则 JIT 编译 (Cranelift，可选)

### 3.2 批量执行优化

- 批量请求合并执行
- 共享上下文复用
- 向量化计算 (SIMD)

### 3.3 内存优化

- 对象池复用 (Context, Value)
- 零拷贝字符串处理 (Cow)
- 内存预分配
- Arena 分配器

### 3.4 并发模型

```
┌─────────────────────────────────────┐
│           Request Queue             │
└─────────────┬───────────────────────┘
              │
    ┌─────────┼─────────┐
    ▼         ▼         ▼
┌───────┐ ┌───────┐ ┌───────┐
│Worker1│ │Worker2│ │Worker3│  (Work-stealing)
└───┬───┘ └───┬───┘ └───┬───┘
    │         │         │
    ▼         ▼         ▼
┌─────────────────────────────────────┐
│      Rule Cache (RwLock/无锁)       │
└─────────────────────────────────────┘
```

- 规则级别读写锁 (读多写少)
- 无锁执行路径
- Work-stealing 调度

---

## Phase 4: 生态扩展 (Ecosystem) - 持续迭代

### 4.1 SDK 生态

| SDK | 优先级 | 原因 |
|-----|--------|------|
| Go | P0 | 大部分后端服务 |
| Java | P1 | 金融行业主流 |
| Python | P2 | 数据/AI 团队 |
| Node.js | P2 | 前端/BFF |

**SDK 功能**:
- 连接池管理
- 自动重试
- 本地缓存
- 熔断降级

### 4.2 规则编排

```
规则链 (Chain):
Rule A → Rule B → Rule C → Result

规则组 (Group):
     ┌→ Rule A ─┐
Input┼→ Rule B ─┼→ Merge → Result
     └→ Rule C ─┘

条件路由:
Input → Router → Rule A (if condition)
              → Rule B (else)
```

### 4.3 动态数据源

| 数据源 | 用途 | 超时 |
|--------|------|------|
| HTTP | 外部服务调用 | 可配置 |
| Redis | 缓存查询 | 10ms |
| 数据库 | 只读查询 | 可配置 |

- 连接池管理
- 超时与熔断保护
- 结果缓存

---

## 架构总览

```
┌─────────────────────────────────────────────────────────────┐
│                    External Systems                          │
│  ┌─────────────────┐              ┌──────────────────────┐  │
│  │ Rule Management │              │  Monitoring System   │  │
│  │     System      │              │ (Prometheus/Grafana) │  │
│  └────────┬────────┘              └──────────▲───────────┘  │
└───────────┼──────────────────────────────────┼──────────────┘
            │ Push Rules (可断开)              │ Metrics
            ▼                                  │
┌─────────────────────────────────────────────────────────────┐
│                 Ordo Engine (Self-Contained)                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                    API Layer                          │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────────────┐   │   │
│  │  │   HTTP   │  │   gRPC   │  │  Health Check    │   │   │
│  │  └────┬─────┘  └────┬─────┘  └────────┬─────────┘   │   │
│  └───────┼─────────────┼─────────────────┼─────────────┘   │
│          │             │                 │                  │
│  ┌───────┴─────────────┴─────────────────┴─────────────┐   │
│  │                  Executor Layer                      │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────────────┐   │   │
│  │  │ Executor │  │  Cache   │  │  Rate Limiter    │   │   │
│  │  │   Pool   │  │ (Memory) │  │  (per tenant)    │   │   │
│  │  └────┬─────┘  └────┬─────┘  └──────────────────┘   │   │
│  └───────┼─────────────┼───────────────────────────────┘   │
│          │             │                                    │
│  ┌───────┴─────────────┴───────────────────────────────┐   │
│  │                  Storage Layer                       │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────────────┐   │   │
│  │  │   WAL    │  │  SQLite  │  │    Recovery      │   │   │
│  │  │   Log    │  │  Store   │  │    Manager       │   │   │
│  │  └──────────┘  └──────────┘  └──────────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
            ▲                 ▲                 ▲
            │                 │                 │
┌───────────┴─────┐ ┌────────┴────────┐ ┌─────┴───────┐
│   Service A     │ │   Service B     │ │  Service C  │
│   (Go SDK)      │ │   (Java SDK)    │ │  (Direct)   │
└─────────────────┘ └─────────────────┘ └─────────────┘
```

---

## 优先级矩阵

| 优先级 | 特性 | 原因 | 阶段 | 预估工时 |
|--------|------|------|------|----------|
| **P0** | 本地持久化 | 重启不丢规则 | Phase 1 | 2周 |
| **P0** | 崩溃恢复 | 秒级恢复 | Phase 1 | 2周 |
| **P0** | 离线运行 | 上游断开不影响 | Phase 1 | 1周 |
| **P0** | 健康检查 | 运维必需 | Phase 1 | 1周 |
| **P1** | 规则签名 | 防篡改 | Phase 2 | 1周 |
| **P1** | 审计日志 | 合规要求 | Phase 2 | 2周 |
| **P1** | 多租户 | 商业化 | Phase 2 | 2周 |
| **P2** | 预编译缓存 | 性能提升 | Phase 3 | 2周 |
| **P2** | 批量执行 | 吞吐量 | Phase 3 | 1周 |
| **P2** | Go SDK | 降低接入成本 | Phase 4 | 2周 |
| **P3** | 规则编排 | 高级场景 | Phase 4 | 3周 |
| **P3** | 动态数据源 | 数据增强 | Phase 4 | 2周 |

---

## 技术选型

| 组件 | 选择 | 原因 | 备选 |
|------|------|------|------|
| 本地存储 | SQLite | 嵌入式，零依赖，成熟稳定 | RocksDB |
| WAL | 自研 | 简单场景，避免复杂依赖 | - |
| 序列化 | bincode | 比 JSON 快 10x | MessagePack |
| 监控 | Prometheus | 行业标准 | OpenTelemetry |
| 日志 | tracing | Rust 生态标准 | slog |
| HTTP | axum | 高性能，Rust 生态 | actix-web |
| gRPC | tonic | Rust 原生 | - |

---

## 里程碑

| 里程碑 | 目标日期 | 交付物 |
|--------|----------|--------|
| M1: 自治基础 | +8周 | 本地持久化、崩溃恢复、离线运行 |
| M2: 企业安全 | +14周 | 签名校验、审计日志、多租户 |
| M3: 性能优化 | +20周 | 预编译、批量执行、内存优化 |
| M4: SDK发布 | +24周 | Go SDK、Java SDK |
| M5: 高级特性 | +30周 | 规则编排、动态数据源 |

---

## 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| SQLite 并发性能 | 高并发写入瓶颈 | WAL 模式 + 批量写入 |
| WAL 文件过大 | 恢复时间增加 | 定期快照压缩 |
| 内存占用过高 | OOM 风险 | LRU 淘汰 + 内存限制 |
| 版本兼容性 | 升级困难 | 版本化存储格式 |

---

## 附录

### A. 配置示例

```yaml
# /etc/ordo/config.yaml
server:
  http_addr: "0.0.0.0:8080"
  grpc_addr: "0.0.0.0:50051"

storage:
  data_dir: "/var/lib/ordo"
  wal_sync_interval: "100ms"
  snapshot_interval: "1h"
  max_versions: 10

execution:
  timeout: "100ms"
  max_depth: 100
  max_memory: "10MB"

upstream:
  enabled: true
  endpoint: "http://rule-management:8080"
  sync_interval: "30s"
  retry_interval: "5s"

metrics:
  enabled: true
  endpoint: "/metrics"
```

### B. API 变更

新增端点:

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/health` | 健康检查 (增强) |
| GET | `/metrics` | Prometheus 指标 |
| POST | `/api/v1/rules/:name/rollback` | 规则回滚 |
| GET | `/api/v1/rules/:name/versions` | 版本列表 |
| GET | `/api/v1/sync/status` | 同步状态 |

---

*文档维护: Ordo Team*  
*最后更新: 2026-01-09*

